{"version":3,"file":"scroll-activity.js","sources":["../../src/services/scroll-activity.js"],"sourcesContent":["import FastBootAwareEventManagerService from './-private/fastboot-aware-event-manager';\nimport { begin as beginRunloop, end as endRunloop } from '@ember/runloop';\nimport getScroll from '../utils/get-scroll';\n\n/*\n * Polling uses rAF and/or a setTimeout at 16ms, however rAF will run in the\n * microtask queue and might fire just after Ember's render step occurred.\n * By enforcing that the interval between a poll and the previous must be\n * below a reasonable number, we can be reasonably sure the main UI\n * thread didn't just do a lot of work.\n *\n * This number should be above the minimum polling period (16ms)\n */\nconst MAX_POLL_PERIOD = 32;\nconst SCROLL_EVENT_TYPE_VERTICAL = 'vertical';\nconst SCROLL_EVENT_TYPE_HORIZONTAL = 'horizontal';\nconst SCROLL_EVENT_TYPE_DIAGONAL = 'diagonal';\n\nexport default class ScrollActivityService extends FastBootAwareEventManagerService {\n  _animationFrame = null;\n  _subscribers = [];\n  _lastCheckAt = new Date();\n\n  constructor() {\n    super(...arguments);\n\n    if (this._isFastBoot) {\n      return;\n    }\n\n    this.subscribe(document, document, () => {}, false);\n\n    this._pollScroll();\n  }\n\n  subscribe(target, element, callback = () => {}, highPriority = true) {\n    this._subscribers.push({\n      target,\n      element,\n      callback,\n      highPriority,\n      scrollTop: null,\n      scrollLeft: null,\n    });\n  }\n\n  unsubscribe(target) {\n    let { _subscribers: subscribers } = this;\n    for (let i = 0; i < subscribers.length; i++) {\n      let subscriber = subscribers[i];\n      if (subscriber.target === target) {\n        subscribers.splice(i, 1);\n        break;\n      }\n    }\n  }\n\n  _pollScroll() {\n    if (this._isFastBoot) {\n      return;\n    }\n    if (window.requestAnimationFrame) {\n      this._animationFrame = requestAnimationFrame(() => this._checkScroll());\n    } else {\n      this._animationFrame = setTimeout(() => this._checkScroll(), 16);\n    }\n  }\n\n  _checkScroll() {\n    let { _subscribers: subscribers } = this;\n    let now = new Date();\n    if (subscribers.length) {\n      if (this._hasScrolled(now)) {\n        this.trigger('scroll');\n        endRunloop();\n      }\n    }\n    this._lastCheckAt = now;\n    this._pollScroll();\n  }\n\n  _updateScroll(subscriber) {\n    subscriber.scrollTop = getScroll(subscriber.element);\n    subscriber.scrollLeft = getScroll(subscriber.element, 'left');\n  }\n\n  _hasScrolled(now) {\n    let { _subscribers: subscribers, _lastCheckAt: lastCheckAt } = this;\n    let lowPriorityFrame = now - lastCheckAt < MAX_POLL_PERIOD;\n    let hasScrolled = false;\n    for (let i = 0; i < subscribers.length; i++) {\n      let subscriber = subscribers[i];\n      if (subscriber.highPriority || lowPriorityFrame) {\n        let scrollTop = getScroll(subscriber.element);\n        let scrollLeft = getScroll(subscriber.element, 'left');\n        if (\n          scrollTop !== subscriber.scrollTop &&\n          scrollLeft !== subscriber.scrollLeft\n        ) {\n          hasScrolled = this._handleAllScrollChanged(subscriber, hasScrolled);\n        } else if (scrollTop !== subscriber.scrollTop) {\n          hasScrolled = this._handleScrollTopChanged(subscriber, hasScrolled);\n        } else if (scrollLeft !== subscriber.scrollLeft) {\n          hasScrolled = this._handleScrollLeftChanged(subscriber, hasScrolled);\n        }\n      }\n    }\n    return hasScrolled;\n  }\n\n  _handleAllScrollChanged(subscriber, hasScrolled) {\n    // If the values are changing from an initial null state to first-time values, do not treat it like a change.\n    if (subscriber.scrollTop !== null && subscriber.scrollLeft !== null) {\n      if (!hasScrolled) {\n        beginRunloop();\n        hasScrolled = true;\n      }\n\n      let scrollTop = getScroll(subscriber.element);\n      let scrollLeft = getScroll(subscriber.element, 'left');\n      subscriber.callback(\n        scrollTop,\n        subscriber.scrollTop,\n        SCROLL_EVENT_TYPE_DIAGONAL,\n        scrollLeft,\n        subscriber.scrollLeft,\n      );\n    }\n    this._updateScroll(subscriber);\n    return hasScrolled;\n  }\n\n  _handleScrollLeftChanged(subscriber, hasScrolled) {\n    // If the value is changing from an initial null state to a first\n    // time value, do not treat it like a change.\n    if (subscriber.scrollLeft !== null) {\n      if (!hasScrolled) {\n        beginRunloop();\n        hasScrolled = true;\n      }\n      subscriber.callback(\n        getScroll(subscriber.element, 'left'),\n        subscriber.scrollLeft,\n        SCROLL_EVENT_TYPE_HORIZONTAL,\n      );\n    }\n    this._updateScroll(subscriber);\n    return hasScrolled;\n  }\n\n  _handleScrollTopChanged(subscriber, hasScrolled) {\n    // If the value is changing from an initial null state to a first\n    // time value, do not treat it like a change.\n    if (subscriber.scrollTop !== null) {\n      if (!hasScrolled) {\n        beginRunloop();\n        hasScrolled = true;\n      }\n      subscriber.callback(\n        getScroll(subscriber.element),\n        subscriber.scrollTop,\n        SCROLL_EVENT_TYPE_VERTICAL,\n      );\n    }\n    this._updateScroll(subscriber);\n    return hasScrolled;\n  }\n\n  willDestroy() {\n    if (this._isFastBoot) {\n      return;\n    }\n    if (window.requestAnimationFrame) {\n      cancelAnimationFrame(this._animationFrame);\n    } else {\n      clearTimeout(this._animationFrame);\n    }\n    this._subscribers.length = 0;\n\n    super.willDestroy(...arguments);\n  }\n}\n"],"names":["MAX_POLL_PERIOD","SCROLL_EVENT_TYPE_VERTICAL","SCROLL_EVENT_TYPE_HORIZONTAL","SCROLL_EVENT_TYPE_DIAGONAL","ScrollActivityService","FastBootAwareEventManagerService","constructor","arguments","_defineProperty","Date","_isFastBoot","subscribe","document","_pollScroll","target","element","callback","highPriority","_subscribers","push","scrollTop","scrollLeft","unsubscribe","subscribers","i","length","subscriber","splice","window","requestAnimationFrame","_animationFrame","_checkScroll","setTimeout","now","_hasScrolled","trigger","endRunloop","_lastCheckAt","_updateScroll","getScroll","lastCheckAt","lowPriorityFrame","hasScrolled","_handleAllScrollChanged","_handleScrollTopChanged","_handleScrollLeftChanged","beginRunloop","willDestroy","cancelAnimationFrame","clearTimeout"],"mappings":"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"}