{"version":3,"file":"user-activity.js","sources":["../../src/services/user-activity.js"],"sourcesContent":["import FastBootAwareEventManagerService from './-private/fastboot-aware-event-manager';\nimport Ember from 'ember';\nimport { A } from '@ember/array';\nimport { throttle } from '@ember/runloop';\nimport { inject as injectService } from '@ember/service';\nimport storageAvailable from '../utils/storage-available';\n\nexport default class UserActivityService extends FastBootAwareEventManagerService {\n  @injectService('scroll-activity')\n  scrollActivity;\n\n  EVENT_THROTTLE;\n  defaultEvents = ['keydown', 'mousedown', 'scroll', 'touchstart', 'storage'];\n  enabledEvents = A();\n  _eventsListened = A();\n  _eventSubscriberCount = {};\n  _throttledEventHandlers = {};\n  _boundEventHandler = null;\n  localStorageKey = 'ember-user-activity';\n\n  // TODO: migrate to constructor\n  // eslint-disable-next-line ember/classic-decorator-hooks\n  init() {\n    super.init(...arguments);\n\n    // Do not throttle in testing mode\n    this.EVENT_THROTTLE = Ember.testing ? 0 : 100;\n\n    this._boundEventHandler = this.handleEvent.bind(this);\n\n    this._setupListeners();\n  }\n\n  on(eventName) {\n    this.enableEvent(eventName);\n    if (this._eventSubscriberCount[eventName]) {\n      this._eventSubscriberCount[eventName]++;\n    } else {\n      this._eventSubscriberCount[eventName] = 1;\n    }\n\n    return super.on(...arguments);\n  }\n\n  off(eventName) {\n    if (this._eventSubscriberCount[eventName]) {\n      this._eventSubscriberCount[eventName]--;\n    } else {\n      delete this._eventSubscriberCount[eventName];\n    }\n\n    return super.off(...arguments);\n  }\n\n  has(eventName) {\n    return (\n      this._eventSubscriberCount[eventName] &&\n      this._eventSubscriberCount[eventName] > 0\n    );\n  }\n\n  handleEvent(event) {\n    if (event.type === 'storage' && event.key !== this.localStorageKey) {\n      return;\n    }\n    throttle(\n      this,\n      this._throttledEventHandlers[event.type],\n      event,\n      this.EVENT_THROTTLE,\n    );\n  }\n\n  _handleScroll() {\n    this.handleEvent({ type: 'scroll' });\n  }\n\n  _setupListeners() {\n    this.defaultEvents.forEach((eventName) => {\n      this.enableEvent(eventName);\n    });\n  }\n\n  _listen(eventName) {\n    if (eventName === 'scroll') {\n      this.scrollActivity.on('scroll', this, this._handleScroll);\n    } else if (this._eventsListened.indexOf(eventName) === -1) {\n      if (this._isFastBoot) {\n        return;\n      }\n      this._eventsListened.pushObject(eventName);\n      window.addEventListener(eventName, this._boundEventHandler, true);\n    }\n  }\n\n  enableEvent(eventName) {\n    if (!this.isEnabled(eventName)) {\n      this.enabledEvents.pushObject(eventName);\n      this._throttledEventHandlers[eventName] = function fireEnabledEvent(\n        event,\n      ) {\n        if (this.isEnabled(event.type)) {\n          this.fireEvent(event);\n        }\n      };\n      this._listen(eventName);\n    }\n  }\n\n  disableEvent(eventName) {\n    this.enabledEvents.removeObject(eventName);\n    this._eventsListened.removeObject(eventName);\n    this._throttledEventHandlers[eventName] = null;\n    if (eventName === 'scroll') {\n      this.scrollActivity.off('scroll', this, this._handleScroll);\n    } else {\n      if (this._isFastBoot) {\n        return;\n      }\n      window.removeEventListener(eventName, this._boundEventHandler, true);\n    }\n  }\n\n  fireEvent(event) {\n    // Only fire events that have subscribers\n    if (this.has(event.type)) {\n      this.trigger(event.type, event);\n    }\n    if (this.has('userActive')) {\n      this.trigger('userActive', event);\n    }\n    if (\n      this._eventsListened.includes('storage') &&\n      storageAvailable('localStorage')\n    ) {\n      // We store a date here since we have to update the storage with a new value\n      localStorage.setItem(this.localStorageKey, new Date());\n    }\n  }\n\n  isEnabled(eventName) {\n    return this.enabledEvents.includes(eventName);\n  }\n\n  willDestroy() {\n    while (this._eventsListened.length > 0) {\n      this.disableEvent(this._eventsListened[0]);\n    }\n    this._eventsListened = A();\n    this._eventSubscriberCount = {};\n    this._throttledEventHandlers = {};\n\n    if (this.localStorageKey && storageAvailable('localStorage')) {\n      localStorage.removeItem(this.localStorageKey);\n    }\n\n    super.willDestroy(...arguments);\n  }\n}\n"],"names":["UserActivityService","_dec","injectService","_class","FastBootAwareEventManagerService","constructor","args","_initializerDefineProperty","_descriptor","_defineProperty","A","init","arguments","EVENT_THROTTLE","Ember","testing","_boundEventHandler","handleEvent","bind","_setupListeners","on","eventName","enableEvent","_eventSubscriberCount","off","has","event","type","key","localStorageKey","throttle","_throttledEventHandlers","_handleScroll","defaultEvents","forEach","_listen","scrollActivity","_eventsListened","indexOf","_isFastBoot","pushObject","window","addEventListener","isEnabled","enabledEvents","fireEnabledEvent","fireEvent","disableEvent","removeObject","removeEventListener","trigger","includes","storageAvailable","localStorage","setItem","Date","willDestroy","length","removeItem","_applyDecoratedDescriptor","prototype","configurable","enumerable","writable","initializer"],"mappings":"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"}